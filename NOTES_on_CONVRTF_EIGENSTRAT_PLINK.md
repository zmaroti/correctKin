# Notes on EIGENSTRAT/PLINK specification and the convertf data conversion behaviour.

In the EIGENSTRAT '.snp' file the 5th column is the major allele, while the 6th column is the minor allele. The official AADR 1240K '.snp' data has the TRUE GRCh37 REF alleles in the 5th column, and the expected ALT allele in the 6th column for each markers:
>            rs3094315     1        0.020130          752566 G A           <- REF G, ALT A according to EIGENSTRAT specification

When convertf is used to convert EIGENSTRAT to PLINK data set, in the resulting PLINK data set the 5th and 6th columns containing the genotypes of the alleles are left in the same order as in the '.snp' file. However in PLINK specification the 5th column denotes the minor allele, while the 6th column denotes the major allele. Accordingly, considering the PLINK specification, in the PLINK file created by convrtf, in the created .'bim' file the REF/ALT alleles flipped.
>            1     rs3094315        0.020130          752566 G A           <- REF A, ALT G according to PLINK specification

Even though convertf kept the same 5th column and 6th column order of alleles. The PLINK data set is still encoding the same genotypes for each samples, as convrtf also 'flip' the GTs in the PLINK data set to represent the same genotypes (actually it keeps the same binary bit representation, but in the PLINK/EIG specification the bits representing the HOMREF/HOMALT alleles are also flipped).

Consequently, when converting a PLINK data to VCF (`plink --bfile PLINKfromCONVERTF --keep-allele-order --real-ref-alleles --recode vcf-iid --output-chr M --out VCFfile`) that was created by convertf from an EIGENSTRAT data set the REF/ALT alleles in the VCF file will be flipped:


>        1   752566  .   A   G   .   PASS    INFO    GT  0/0 1/1 0/1       <- this codes           A/A G/G and A/G genotyopes in the 3 hypothetical examples, here the REF/ALT is flipped compared to GRCh37

Note, that in the VCF file, REF and ALT alleles (column 4 and 5 in VCF) are flipped compared to the original GRCh37 REF/ALT. \
In case convrtf handled minor/major alleles properly, the same GTs would be encoded as:
>        1   752566  .   G   A   .   PASS    INFO    GT  1/1 0/0 0/1       <- this codes the same: A/A G/G and A/G genotypes, however the REF and ALT is kept as in GRCh37.

Even though both data set encode the same GTs for the included samples, the PLINK data set generated by the convertf tool has flipped REF/ALT and GTs compared to the GRCh37 reference.

## Notes on importHaplocall behaviour
By default importHaplocall mimicks the convertf behaviour (flipped GT/minor/major) and creates a PLINK data set that can be imported to EIGENSTRAT by convertf to result in a proper GRCh37 and AADR data set conformant '.snp' file. However, this also means that conforming with the "broken" behaviour of convertf, our PLINK data set cannot be exported to a proper VCF file with the true REF/ALT alleles. To handle this scenario, we added the '-noflip' option to the importHaploCall tool. Using the '-noflip' option the imported PLINK data set will conform with the PLINK specification of major/minor order. Hence data imported with the '-nopflip' option can be exported to VCF with the proper GRCh37 REF/ALT alleles and can be compared to VCF data, or merged with VCF data.

## Notes on PLINK beaviour
Actually if you are working in PLINK it doesn't matter how the minor/major is encoded in the '.bim' file while the GTs are also corresponding to it. In fact without the '--keep-allele-order' flag PLINK always recalculate minor/major of each markers on the current data set. So if you add/remove samples and the ratio of GTs for any marker changes PLINK will create a data set with a different '.bim' file where the major/minor alleles represent the allele frequencies in your ACTUAL data set. And naturally PLINK handles the merging of data sets properly, regardless how their actual '.bim' minor/major order is.

So keeping your minor/major order **only matters if you want to export your data set to VCF file with proper REF/ALT alleles** and compare your data with other data that is available in VCF format. In this case, you **MUST** add the '--keep-allele-order' flag to ALL of your PLINK commands (adding/removing samples, extracting markers etc). Furthermore, when exporting to VCF **you also have to include** the '--real-ref-alleles' option in your PLINK command to export with proper REF/ALT alleles (considering that in your .bim 6th column is the REF and 5th column is the ALT allele as defined in PLINK specification).

In case you merge two PLINK data set with the '--keep-allele-order' then the minor/major as specified in the '.bim' file of the first data set will be forced on the RESULTing output:
    `pink --bfile FIRST --bmerge --OTHER --keep-allele-order --out RESULT`

This can be used to force minor/major order to proper REF/ALT or the broken flipped ALT/REF order in case two data sets are from different sources (convertf/importHaplocall). Thus changing the order of the data sets in plink merge command (--bfile/--bmerge) allows to export to proper VCF or the "flipped" EIGENSTRAT representation (which can be exported to EIGENSTRAT by convrtf restoring the proper minor/majors).
